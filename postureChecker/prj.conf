#################
# Debugging
#################
CONFIG_DEBUG=y
CONFIG_DEBUG_INFO=y
CONFIG_EXCEPTION_STACK_TRACE=y
CONFIG_THREAD_NAME=y
CONFIG_MPU_STACK_GUARD=y
CONFIG_RESET_ON_FATAL_ERROR=n


#################
# Memory settings
#################
CONFIG_MAIN_STACK_SIZE=2048
CONFIG_ISR_STACK_SIZE=4096
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4096


####################################
# Bluetooth Low Energy configuration
####################################
# General features
CONFIG_BT=y
CONFIG_BT_PERIPHERAL=y
CONFIG_BT_GATT_CLIENT=y
CONFIG_BT_DEVICE_NAME="Posture"

# Security
CONFIG_BT_SMP=y
CONFIG_BT_SMP_SC_ONLY=y
CONFIG_BT_MAX_CONN=2
CONFIG_BT_MAX_PAIRED=2
CONFIG_BT_FILTER_ACCEPT_LIST=y

# Required to skip InitRandomStaticAddress() in modules/lib/matter/src/platform/Zephyr/BLEManagerImpl.cpp
# and settings_load() after PlatformMgr().InitChipStack()
CONFIG_BT_PRIVACY=y
CONFIG_BT_SMP_APP_PAIRING_ACCEPT=y

## Enable bonding
CONFIG_BT_SETTINGS=y
CONFIG_FLASH=y
CONFIG_FLASH_PAGE_LAYOUT=y
CONFIG_FLASH_MAP=y
CONFIG_NVS=y
CONFIG_SETTINGS=y

## Increase packet size
CONFIG_BT_DATA_LEN_UPDATE=y
CONFIG_BT_USER_DATA_LEN_UPDATE=y
CONFIG_BT_CTLR_DATA_LENGTH_MAX=251
CONFIG_BT_BUF_ACL_RX_SIZE=251
CONFIG_BT_BUF_ACL_TX_SIZE=251
CONFIG_BT_L2CAP_TX_MTU=247

CONFIG_BT_PHY_UPDATE=y
CONFIG_BT_USER_PHY_UPDATE=y
CONFIG_BT_AUTO_PHY_UPDATE=y

## 500ms connection interval, peripheral latency 0 connection intervals, supervision timeout 4s
#CONFIG_BT_PERIPHERAL_PREF_MIN_INT=400
#CONFIG_BT_PERIPHERAL_PREF_MAX_INT=400
#CONFIG_BT_PERIPHERAL_PREF_LATENCY=0
#CONFIG_BT_PERIPHERAL_PREF_TIMEOUT=400
CONFIG_BT_GAP_AUTO_UPDATE_CONN_PARAMS=y


###################
# USB configuration
###################
CONFIG_USB_DEVICE_STACK=y
CONFIG_USB_DEVICE_PRODUCT="Posture Checker"
CONFIG_USB_CDC_ACM=y
CONFIG_UART_LINE_CTRL=y

# The build should not complain about using the default device ids
CONFIG_USB_DEVICE_VID=0x1234
CONFIG_USB_DEVICE_PID=0x5678

CONFIG_USB_DEVICE_MANUFACTURER="J"
CONFIG_USB_DEVICE_SN="MLB_000000000000"

CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT=y

CONFIG_USB_COMPOSITE_DEVICE=n
CONFIG_USB_MAX_NUM_TRANSFERS=8

CONFIG_USB_REQUEST_BUFFER_SIZE=2048

CONFIG_USB_MASS_STORAGE=y
CONFIG_USB_DRIVER_LOG_LEVEL_ERR=y
CONFIG_USB_DEVICE_LOG_LEVEL_ERR=y
CONFIG_USB_MASS_STORAGE_LOG_LEVEL_ERR=y

CONFIG_DISK_DRIVER_FLASH=y
# defaults if CONFIG_DISK_DRIVER_FLASH=y
CONFIG_MASS_STORAGE_DISK_NAME="NAND"
CONFIG_FLASHDISK_VERIFY_PAGE_LAYOUT=y


#######
# Shell
#######
CONFIG_SHELL=y
CONFIG_SHELL_PROMPT_UART="$ "
CONFIG_SHELL_BACKEND_SERIAL_CHECK_DTR=y
CONFIG_SHELL_VT100_COMMANDS=n
CONFIG_SHELL_DEFAULT_TERMINAL_WIDTH=100
CONFIG_SHELL_STACK_SIZE=3168
CONFIG_ADC_SHELL=n
CONFIG_SHELL_CMD_BUFF_SIZE=128
CONFIG_SHELL_BACKEND_SERIAL_RX_RING_BUFFER_SIZE=128


##########
# logging
##########
CONFIG_LOG=y
CONFIG_LOG_MODE_MINIMAL=n
CONFIG_LOG_MODE_DEFERRED=y
#CONFIG_LOG_MODE_IMMEDIATE=n
CONFIG_LOG_BUFFER_SIZE=12288
CONFIG_LOG_BACKEND_SHOW_COLOR=n

CONFIG_LOG_BACKEND_UART=y
CONFIG_SHELL_LOG_BACKEND=n

CONFIG_CBPRINTF_FP_SUPPORT=y

CONFIG_I2C_DUMP_MESSAGES=n
CONFIG_I2C_LOG_LEVEL_DBG=y
CONFIG_MAIN_LOG_LEVEL_DBG=y
CONFIG_ML_APP_EI_DATA_FORWARDER_LOG_LEVEL_INF=y
CONFIG_EI_WRAPPER_LOG_LEVEL_WRN=y
CONFIG_SENSOR_LOG_LEVEL_DBG=y
CONFIG_SENSORS_LOG_LEVEL_INF=y
CONFIG_USB_CDC_ACM_LOG_LEVEL_OFF=y
CONFIG_DATE_TIME_LOG_LEVEL_ERR=y


##############
# Edge Impulse
##############
CONFIG_EDGE_IMPULSE=y
CONFIG_EI_WRAPPER_DATA_BUF_SIZE=2500
CONFIG_EI_WRAPPER_THREAD_STACK_SIZE=4096
CONFIG_EI_WRAPPER_THREAD_PRIORITY=5
CONFIG_EI_WRAPPER_PROFILING=y
CONFIG_EI_WRAPPER_DEBUG_MODE=n

CONFIG_EDGE_IMPULSE_DOWNLOAD_ALWAYS=y
# Requires credentials set as EI_API_KEY_HEADER in cmake before this configuration is read
CONFIG_EDGE_IMPULSE_URI="https://studio.edgeimpulse.com/v1/api/276797/deployment/download?type=zip&engine=tflite-eon"
#CONFIG_EDGE_IMPULSE_URI="model/posture-checker-v3.zip"

CONFIG_ML_APP_EI_DATA_FORWARDER=y
CONFIG_ML_APP_EI_DATA_FORWARDER_BT_NUS=y
CONFIG_ML_APP_EI_DATA_FORWARDER_UART=y
CONFIG_ML_APP_EI_DATA_FORWARDER_PIPELINE_COUNT=3
CONFIG_ML_APP_EI_DATA_FORWARDER_BUF_COUNT=6

CONFIG_CPLUSPLUS=y
CONFIG_LIB_CPLUSPLUS=y
CONFIG_STD_CPP11=y
CONFIG_FP16=n

CONFIG_NEWLIB_LIBC=y
CONFIG_NEWLIB_LIBC_FLOAT_PRINTF=y

CONFIG_BT_NUS=y


##########
# Memfault
##########
# General
CONFIG_MEMFAULT=y
CONFIG_MEMFAULT_SHELL=y
CONFIG_MEMFAULT_USER_CONFIG_ENABLE=y

# Memfault over BLE
CONFIG_BT_MDS=y

# Heap memory is required for the memfault_demo_cli.c
CONFIG_HEAP_MEM_POOL_SIZE=256

# Device info
CONFIG_MEMFAULT_NCS_DEVICE_ID="postureChecker"
CONFIG_MEMFAULT_NCS_FW_VERSION_AUTO=y
#CONFIG_MEMFAULT_NCS_HW_VERSION="0.1.0+"
#CONFIG_MEMFAULT_NCS_FW_TYPE="posture"
#CONFIG_MEMFAULT_NCS_FW_VERSION_PREFIX="0.1.0+"
#CONFIG_MEMFAULT_DEVICE_ID="52840"

# Collected metris
CONFIG_MEMFAULT_METRICS=y
CONFIG_MEMFAULT_METRICS_DEFAULT_SET_ENABLE=y
CONFIG_MEMFAULT_METRICS_EXTRA_DEFS_FILE=y
CONFIG_MEMFAULT_NCS_STACK_METRICS=y
CONFIG_MEMFAULT_NCS_BT_METRICS=y

# Include logging
CONFIG_MEMFAULT_LOGGING_ENABLE=y
CONFIG_MEMFAULT_LOGGING_RAM_SIZE=1024

# Store coredump to flash
CONFIG_MEMFAULT_COREDUMP_COLLECT_BSS_REGIONS=y
CONFIG_MEMFAULT_COREDUMP_COLLECT_DATA_REGIONS=y
CONFIG_MEMFAULT_NCS_INTERNAL_FLASH_BACKED_COREDUMP=n

# Dependencies MEMFAULT_NCS_INTERNAL_FLASH_BACKED_COREDUMP
#CONFIG_FLASH=y
#CONFIG_IMG_MANAGER=y
#CONFIG_BOOTLOADER_MCUBOOT=y
#CONFIG_MCUBOOT_IMG_MANAGER=y

# Other dependencies
CONFIG_BASE64=y


############
# Filesystem
############
# Need this when storage is on flash
CONFIG_MPU_ALLOW_FLASH_WRITE=y

# Need this when storage is on MX25R64
CONFIG_NORDIC_QSPI_NOR=y
CONFIG_NORDIC_QSPI_NOR_FLASH_LAYOUT_PAGE_SIZE=4096

CONFIG_FILE_SYSTEM=y
CONFIG_FILE_SYSTEM_LITTLEFS=y


############
# App
############
CONFIG_APP_WIPE_STORAGE=n
CONFIG_APP_USER_FILTER_ACCESS_LIST=n
CONFIG_APP_REQUIRE_OOB=n

CONFIG_I2C=y
CONFIG_SENSOR=y
CONFIG_ADC=y
CONFIG_ADC_ADS1X1X=y

CONFIG_DATE_TIME=y
# need to manually switch this off as no network is enabled and KConfig does not pass
CONFIG_DATE_TIME_NTP=n

CONFIG_USE_SIMULATION_DATA=y