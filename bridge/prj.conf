#################
# Debugging
#################
# Debug information
CONFIG_DEBUG=n
CONFIG_DEBUG_OPTIMIZATIONS=n
CONFIG_DEBUG_INFO=y
CONFIG_DEBUG_THREAD_INFO=y

CONFIG_THREAD_NAME=y
CONFIG_THREAD_MONITOR=y

CONFIG_MPU_STACK_GUARD=y

CONFIG_RESET_ON_FATAL_ERROR=y

# Disabling assertions saves # Disabling shell saves 18,524 bytes of flash bytes of flash
CONFIG_ASSERT=n
CONFIG_ASSERT_VERBOSE=n



#################
# Memory settings
#################
# Workqueue
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=8192

# Stack sizes
CONFIG_ISR_STACK_SIZE=2048
CONFIG_MAIN_STACK_SIZE=6144
CONFIG_SHELL_STACK_SIZE=8192
# Raised to avoid crash default 2200 if BT_SETTINGS
CONFIG_BT_RX_STACK_SIZE=3072

# defaults
#CONFIG_NET_TX_STACK_SIZE=4096
#CONFIG_NET_RX_STACK_SIZE=4096
#CONFIG_NET_MGMT_EVENT_STACK_SIZE=4096
#CONFIG_NRF700X_WORKQ_STACK_SIZE=4096
#CONFIG_WFA_QT_THREAD_STACK_SIZE=4096
#CONFIG_WPA_SUPP_THREAD_STACK_SIZE=8192
#CONFIG_WPA_SUPP_WQ_STACK_SIZE=4096

# Heap sizes
CONFIG_HEAP_MEM_POOL_SIZE=155000
CONFIG_MBEDTLS_HEAP_SIZE=32768

# Other large contributors
# MEMORY -> If 10 then RX Buf 22.63kB (CONFIG_LV_Z_BITS_PER_PIXEL * ((CONFIG_LV_Z_VDB_SIZE * DISPLAY_WIDTH * DISPLAY_HEIGHT) / 100) / 8)
CONFIG_LV_Z_VDB_SIZE=2

# MEMORY (Flash disk cache in overlay) -> 4kB
# MEMORY (CHIP heap) -> 28kB
# MEMORY (CHIP packet buffer) -> 12.5kB
# MEMORY (CHIP server) -> 11.17kB
# MEMORY (CHIP Interaction Model Engine) -> 9.55kB
# MEMORY (CHIP Device Layer Thread Stack) -> 6.06kB


# MEMORY (Recorder buffer) -> 93.75kB
# MEMORY (Recorder stack size) -> 6.06kB
# MEMORY (AI Send buffer) -> 4kB
# MEMORY (AI Recv buffer) -> 4kB
# MEMORY (AI Response buffer) -> 1kB

# In case of wifi 20kB larger than Openthread
#CONFIG_CHIP_MALLOC_SYS_HEAP_SIZE=28672



# Buffers for network and nRF7002
# https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/device_guides/working_with_nrf/nrf70/developing/constrained.html

# Increase BUF_TX_COUNT, otherwise sending large data fails.
# Decrease RX_NUM_BUFS, RX_MAX_DATA_SIZE to save memory
# Matter sets low MAX_TX_AGGREGATION, increase again for faster transfer
# Commented out are defaults

#CONFIG_NET_PKT_RX_COUNT=8
#CONFIG_NET_PKT_TX_COUNT=8
#CONFIG_NET_BUF_RX_COUNT=16
CONFIG_NET_BUF_TX_COUNT=32

#CONFIG_NET_BUF_DATA_SIZE=128

# MEMORY -> RX Buf (128*16) 2kB
# MEMORY -> TX Buf (128*32) 4kB

# Decrease to save memory
CONFIG_NRF700X_RX_NUM_BUFS=12
CONFIG_NRF700X_RX_MAX_DATA_SIZE=800
CONFIG_NRF700X_MAX_TX_AGGREGATION=12
#CONFIG_NRF700X_MAX_TX_TOKENS=10
#CONFIG_NRF700X_TX_MAX_DATA_SIZE=1600

#CONFIG_NET_SOCKETPAIR_BUFFER_SIZE=4096



#################
# Matter
#################
CONFIG_CHIP=y
CONFIG_CHIP_PROJECT_CONFIG="src/chip_project_config.h"

CONFIG_CHIP_ENABLE_PAIRING_AUTOSTART=y
CONFIG_CHIP_OTA_REQUESTOR=n
CONFIG_CHIP_NFC_COMMISSIONING=n
CONFIG_CHIP_QSPI_NOR=n
# Factory data
CONFIG_CHIP_FACTORY_DATA=n
CONFIG_CHIP_FACTORY_DATA_BUILD=n
# All commented out because with a different discriminator, commissioning on Macs does not work anymore.
#CONFIG_CHIP_FACTORY_DATA_MERGE_WITH_FIRMWARE=y
#CONFIG_CHIP_FACTORY_DATA_USE_DEFAULT_CERTS=y
#CONFIG_CHIP_DEVICE_SERIAL_NUMBER="1"
#CONFIG_CHIP_DEVICE_VENDOR_ID=65521
#CONFIG_CHIP_DEVICE_VENDOR_NAME="J"
# 32770 == 0x8002 (example bridge)
#CONFIG_CHIP_DEVICE_PRODUCT_ID=32770
#CONFIG_CHIP_DEVICE_PRODUCT_NAME="Matter IoT Bridge"
#CONFIG_CHIP_DEVICE_MANUFACTURING_DATE="2023-11-15"
#CONFIG_CHIP_DEVICE_HARDWARE_VERSION=1
#CONFIG_CHIP_DEVICE_HARDWARE_VERSION_STRING="1.0"
#CONFIG_CHIP_DEVICE_DISCRIMINATOR=0xF01

# Reduced the storage to 0x1000 to save Flash for application.
# This is no multiple of 0x4000, which is a requirement for flash write protection.
# See modules/lib/matter/src/platform/nrfconnect/FactoryDataProvider.h:63:44: 
# error: static assertion failed: FPROTECT memory block, which contains factory datapartition overlaps with the settings partition.
# Probably your settings partition size is not a multipleof the atomic FPROTECT block size of 0x4000kB
# Anyway, only valid if CONFIG_CHIP_FACTORY_DATA=y
# CONFIG_CHIP_FACTORY_DATA_WRITE_PROTECT=n


####################################
# Bluetooth Low Energy configuration
####################################
CONFIG_BT=y
CONFIG_BT_CENTRAL=y
CONFIG_BT_SCAN=y
CONFIG_BT_SCAN_FILTER_ENABLE=y
CONFIG_BT_SCAN_ADDRESS_CNT=1
CONFIG_BT_SCAN_UUID_CNT=2
CONFIG_BT_GATT_CLIENT=y
CONFIG_BT_GATT_DM=y

CONFIG_BT_DEVICE_NAME="MatterBridge"

## Security
CONFIG_BT_SMP=y
CONFIG_BT_MAX_CONN=2
CONFIG_BT_MAX_PAIRED=2
# Required to skip InitRandomStaticAddress() in modules/lib/matter/src/platform/Zephyr/BLEManagerImpl.cpp
# and settings_load() after PlatformMgr().InitChipStack()
CONFIG_BT_PRIVACY=y
CONFIG_BT_SMP_APP_PAIRING_ACCEPT=y

## Enable bonding
CONFIG_BT_SETTINGS=y
CONFIG_FLASH=y
CONFIG_FLASH_PAGE_LAYOUT=y
CONFIG_FLASH_MAP=y
CONFIG_NVS=y
CONFIG_SETTINGS=y

# Debug prints
CONFIG_BT_GATT_DM_DATA_PRINT=n

## Increase packet size - defaults by matter are ok
#CONFIG_BT_BUF_ACL_RX_SIZE=502
#CONFIG_BT_BUF_ACL_TX_SIZE=251
#CONFIG_BT_L2CAP_TX_MTU=247



###################
# USB configuration
###################
# Disabling USB saves 15,332 bytes of flash
CONFIG_USB_DEVICE_STACK=n
#CONFIG_USB_DEVICE_PRODUCT="MatterBridge"
#CONFIG_USB_CDC_ACM=n
#CONFIG_UART_LINE_CTRL=y
#CONFIG_USB_REQUEST_BUFFER_SIZE=2048
#
#CONFIG_USB_DEVICE_VID=0x1234
#CONFIG_USB_DEVICE_PID=0x5678
#
#CONFIG_USB_DEVICE_MANUFACTURER="J"
#CONFIG_USB_DEVICE_SN="MLB_000000000000"
#
#CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT=y
#
#CONFIG_USB_COMPOSITE_DEVICE=n
#CONFIG_USB_MAX_NUM_TRANSFERS=8
#
#CONFIG_USB_MASS_STORAGE=y
#CONFIG_MASS_STORAGE_STACK_SIZE=1024
## USB mass storage needs an increase. (Stack overflow)
#CONFIG_USB_NRFX_WORK_QUEUE_STACK_SIZE=2048
#
# NAND defaults if CONFIG_DISK_DRIVER_FLASH=y
#CONFIG_MASS_STORAGE_DISK_NAME="NAND"



############
# Wifi
############
CONFIG_WIFI=y
CONFIG_WIFI_NRF700X=y

CONFIG_WPA_SUPP=y
# save flash memory
CONFIG_WPA_SUPP_ADVANCED_FEATURES=n



############
# Networking
############
CONFIG_NET_IPV4=y
CONFIG_NET_TCP=y
CONFIG_NET_DHCPV4=y

CONFIG_NET_SOCKETS_POLL_MAX=12
CONFIG_NET_IF_UNICAST_IPV4_ADDR_COUNT=1

# Raise contexts to do multiple ntp requests and open.ai requests simultaneous
# MEMORY -> 7.98kB
CONFIG_NET_MAX_CONTEXTS=20

CONFIG_DNS_RESOLVER=y
CONFIG_DNS_SERVER_IP_ADDRESSES=y
CONFIG_DNS_SERVER1="8.8.8.8"
# defaults
#CONFIG_DNS_RESOLVER_MAX_SERVERS=1
#CONFIG_DNS_NUM_CONCUR_QUERIES=1

CONFIG_NET_MAX_CONN=16
# MEMORY -> 4.10kB
CONFIG_NET_MGMT_EVENT_QUEUE_SIZE=50
CONFIG_NET_MGMT_EVENT_QUEUE_TIMEOUT=5000



############
# MbedTLS and security
############
CONFIG_MBEDTLS=y
CONFIG_NET_SOCKETS_SOCKOPT_TLS=y
CONFIG_MBEDTLS_TLS_LIBRARY=y
CONFIG_MBEDTLS_X509_LIBRARY=y

# Required to connect to open.ai
CONFIG_MBEDTLS_RSA_C=y
CONFIG_MBEDTLS_SSL_SERVER_NAME_INDICATION=y

# These sizes depend on the length of the certificate (chain)
# They are required to establish ssl connection with open.ai
CONFIG_MBEDTLS_ENABLE_HEAP=y
CONFIG_MBEDTLS_SSL_IN_CONTENT_LEN=3072
CONFIG_MBEDTLS_SSL_OUT_CONTENT_LEN=3072
CONFIG_MBEDTLS_HEAP_SIZE=32768



############
# Flash & Filesystem
############
CONFIG_DISK_ACCESS=y
CONFIG_FILE_SYSTEM=y
CONFIG_FAT_FILESYSTEM_ELM=y
CONFIG_FS_FATFS_LFN=y
CONFIG_FS_FATFS_LFN_MODE_STACK=y
# Already set above for BT
#CONFIG_FLASH=y
#CONFIG_FLASH_MAP=y
#CONFIG_FLASH_PAGE_LAYOUT=y

CONFIG_DISK_DRIVER_FLASH=y

CONFIG_SPI_NOR_FLASH_LAYOUT_PAGE_SIZE=4096

# When the PM is active additional settings are required.
# Finally the FFS1 is defined as static partition in pm_static_nrf7002dk_nrf5340_cpuapp.yml
CONFIG_PM_OVERRIDE_EXTERNAL_DRIVER_CHECK=y
CONFIG_PM_PARTITION_SIZE_FFS1=0x100000
CONFIG_PM_PARTITION_REGION_FFS1_EXTERNAL=y



#######
# Shell
#######
# Disabling shell saves 18,524 bytes of flash
CONFIG_SHELL=y
CONFIG_SHELL_PROMPT_UART="$ "
CONFIG_SHELL_VT100_COMMANDS=n
CONFIG_SHELL_DEFAULT_TERMINAL_WIDTH=100
CONFIG_SHELL_CMD_BUFF_SIZE=128
CONFIG_SHELL_BACKEND_SERIAL_RX_RING_BUFFER_SIZE=128

CONFIG_CHIP_LIB_SHELL=n
CONFIG_BT_SHELL=n

CONFIG_SHELL_LOG_BACKEND=n



##########
# logging
##########
# Disabling log saves 22,460 bytes of flash
CONFIG_LOG=y
CONFIG_LOG_MODE_MINIMAL=n
CONFIG_LOG_MODE_DEFERRED=y
CONFIG_LOG_MODE_IMMEDIATE=n
CONFIG_LOG_BUFFER_SIZE=6144
CONFIG_LOG_BACKEND_SHOW_COLOR=n 

CONFIG_LOG_BACKEND_UART=y

# Logs when using Debugger.
CONFIG_USE_SEGGER_RTT=n
#CONFIG_LOG_BACKEND_RTT=y
#CONFIG_LOG_BACKEND_RTT_MODE_DROP=y
#CONFIG_LOG_BACKEND_RTT_MESSAGE_SIZE=256
#CONFIG_SHELL_BACKEND_RTT=n
#CONFIG_SEGGER_RTT_BUFFER_SIZE_UP=4096

# log level settings
CONFIG_LOG_RUNTIME_FILTERING=n
CONFIG_LOG_DEFAULT_LEVEL=3

CONFIG_BT_LOG_LEVEL_INF=y
#CONFIG_MATTER_LOG_LEVEL_INF=y
#CONFIG_DATE_TIME_LOG_LEVEL_DBG=y
#CONFIG_BT_GATT_LOG_LEVEL_DBG=y
#CONFIG_FLASH_LOG_LEVEL_DBG=y
#CONFIG_USB_MASS_STORAGE_LOG_LEVEL_DBG=y
#CONFIG_USB_DEVICE_LOG_LEVEL_DBG=y
#CONFIG_NET_HTTP_LOG_LEVEL_DBG=y
#CONFIG_NET_LOG=y

#CONFIG_DISPLAY_LOG_LEVEL_DBG=y
#CONFIG_LV_USE_LOG=y
#CONFIG_LV_LOG_LEVEL_INFO=y
#CONFIG_LV_LOG_PRINTF=y


############
# App
############
# Add suppot for LEDs and buttons on Nordic development kits
CONFIG_DK_LIBRARY=y

# Add support for PDM microphone
CONFIG_NRFX_PDM=y

# Parsing of Json with its dependencies
CONFIG_CJSON_LIB=y
CONFIG_NEWLIB_LIBC=y
CONFIG_NEWLIB_LIBC_FLOAT_PRINTF=y

# Using functions for time
CONFIG_DATE_TIME=y
CONFIG_DATE_TIME_NTP=y

# Make http requests
CONFIG_HTTP_CLIENT=y

# Communication with Raspberry Pico (NFC over USB)
CONFIG_UART_INTERRUPT_DRIVEN=y

# To be implemented. At the moment not enough flash. Wait for the nRF70 firmware to be put onto flash.
# Display
CONFIG_LV_Z_MEM_POOL_NUMBER_BLOCKS=1
CONFIG_LV_MEM_BUF_MAX_NUM=1
CONFIG_DISPLAY=y

CONFIG_LVGL=y
CONFIG_LV_CONF_MINIMAL=y
CONFIG_LV_MEM_CUSTOM=y

CONFIG_LV_USE_LABEL=y


CONFIG_LV_Z_USE_FILESYSTEM=n


############
# Other
############
# appends -std=gnu++20 while CPP20 results in a compile error Building with unsupported C++ standard
# CONFIG_STD_CPP2A=y
CONFIG_STD_CPP14=y

CONFIG_ENTROPY_GENERATOR=y
CONFIG_POSIX_CLOCK=y
CONFIG_POLL=y

# Do I need these?
CONFIG_MPU_ALLOW_FLASH_WRITE=y
CONFIG_SPI_NOR_CS_WAIT_DELAY=5

# With 2.5.1, the bootloader is skipped if not required (no OTA) (?)
#CONFIG_BOOTLOADER_MCUBOOT=y
#CONFIG_MCUBOOT_BUILD_STRATEGY_SKIP_BUILD=y
#CONFIG_MULTIPROTOCOL_RPMSG_BUILD_STRATEGY_SKIP_BUILD=y